name: release

on:
  workflow_dispatch:
    inputs:
      next_version:
        description: |
          Next release version. Possible values: x.y.z, major, minor, patch.
          Also, you can pass 'skip' to skip git tag and create release for the current version.
        required: true
        type: string
      release_title:
        description: 'Title for the GitHub release (optional, defaults to version)'
        required: false
        type: string
      release_notes:
        description: 'Release notes (optional, defaults to changelog)'
        required: false
        type: string
      create_discussion:
        description: 'Create a GitHub discussion for the release (true/false)'
        required: false
        type: boolean
        default: true
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Get current version from build.gradle
      id: current_version
      run: |
        CURRENT_VERSION=$(grep '^version=' build.gradle | sed "s/version=//" | sed "s/'//g" | sed "s/ //g")
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Detected current version: $CURRENT_VERSION"

    - name: Calculate next version
      id: next_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current }}"

        if [[ "${{ inputs.next_version }}" == "major" ]]; then
          NEXT=$(echo $CURRENT | awk -F. '{$1+=1; $2=0; $3=0} OFS=. print $1"."$2"."$3}')
        elif [[ "${{ inputs.next_version }}" == "minor" ]]; then
          NEXT=$(echo $CURRENT | awk -F. '{$2+=1; $3=0} OFS=. print $1"."$2"."$3}')
        elif [[ "${{ inputs.next_version }}" == "patch" ]]; then
          NEXT=$(echo $CURRENT | awk -F. '{$3+=1} OFS=. print $1"."$2"."$3}')
        elif [[ "${{ inputs.next_version }}" == "skip" ]]; then
          NEXT=$CURRENT
        else
          NEXT="${{ inputs.next_version }}"
        fi

        echo "next=$NEXT" >> $GITHUB_OUTPUT
        echo "tag=v$NEXT" >> $GITHUB_OUTPUT
        echo "Calculated next version: $NEXT"

    - name: Update version in build.gradle
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        NEXT="${{ steps.next_version.outputs.next }}"
        sed -i "s/^version=.*/version=\"$NEXT\"/" build.gradle
        echo "Updated build.gradle version to $NEXT"

    - name: Commit version bump
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        NEXT="${{ steps.next_version.outputs.next }}"
        git add build.gradle
        git commit -m "chore: bump version to $NEXT"
        git push

    - name: Create and push git tag
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        TAG="${{ steps.next_version.outputs.tag }}"
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"
        echo "Created and pushed tag: $TAG"

    - name: Build plugin using Gradle (production build)
      run: |
        echo "ğŸ—ï¸ Building production plugin..."
        chmod +x build.sh
        ./build.sh --production
        echo "âœ… Plugin built successfully"

    - name: Verify plugin.yml structure
      run: |
        echo "ğŸ” Verifying plugin.yml structure..."
        JAR_FILE=$(find build/libs -name "elemental-dragon-*.jar" | head -1)
        echo "Found JAR: $JAR_FILE"
        jar tf "$JAR_FILE" | grep plugin.yml
        echo "âœ… Plugin.yml verified"

    - name: Get release notes
      id: release_notes
      run: |
        if [[ -n "${{ inputs.release_notes }}" ]]; then
          NOTES="${{ inputs.release_notes }}"
        else
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -z "$PREV_TAG" ]]; then
            NOTES="## ğŸ‰ Initial Release

This is the first release of Elemental Dragon plugin!"
          else
            NOTES="## ğŸ“ Changes

$(git log $PREV_TAG..HEAD --oneline | sed 's/^/- /')"
          fi
        fi

        # Add version header
        NOTES="## Release ${{ steps.next_version.outputs.tag }}

$NOTES"

        # Add installation instructions
        NOTES="$NOTES

## ğŸ“¥ Installation

1. Download \`elemental-dragon-*.jar\` below
2. Place in \`plugins/\` directory
3. Restart Paper 1.21.8+ server
4. No configuration needed!

## âš¡ Quick Start

\`\`\`bash
/give @p minecraft:dragon_egg  # Get dragon egg
# Move to offhand (F key)
/lightning 1                      # Strike with lightning!
\`\`\`

## ğŸ“‹ System Requirements

- Minecraft: Java Edition 1.21.8+
- Server: Paper 1.21.8-R0.1+
- Java: 21 or higher
"

        # Write to file for multi-line support
        echo "$NOTES" > /tmp/release_notes.txt

        # Set output (single line for GitHub Actions)
        delimiter="$(openssl rand -hex 8)"
        echo "notes<<$delimiter" >> $GITHUB_OUTPUT
        cat /tmp/release_notes.txt >> $GITHUB_OUTPUT
        echo "$delimiter" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.next_version.outputs.tag }}
        name: ${{ inputs.release_title || format('Elemental Dragon Plugin {0}', steps.next_version.outputs.next) }}
        body: ${{ steps.release_notes.outputs.notes }}
        draft: false
        prerelease: false
        files: |
          build/libs/elemental-dragon-*.jar
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create GitHub Discussion (Announcement)
      if: ${{ inputs.create_discussion }}
      uses: peter-evans/create-discussion@v3
      with:
        title: ${{ inputs.release_title || format('Elemental Dragon Plugin {0} Released!', steps.next_version.outputs.next) }}
        body: |
          **Elemental Dragon Plugin ${{ steps.next_version.outputs.next }} has been released!** :rocket:

          ${{ steps.release_notes.outputs.notes }}

          **Download**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.next_version.outputs.tag }}
        category: Announcements
        repository-discussions: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Repository dispatch (release-passed event)
      uses: peter-evans/repository-dispatch@v3
      if: ${{ inputs.create_discussion }}
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        event-type: release-passed
        client-payload: '{"ref": "${{ steps.next_version.outputs.tag }}", "sha": "${{ github.sha }}", "type": "release-passed"}'

    - name: Verify Release
      run: |
        echo "ğŸ‰ Verifying release creation..."
        echo ""

        if gh release view ${{ steps.next_version.outputs.tag }} --json id --jq '.id' 2>/dev/null; then
          echo "âœ… Release ${{ steps.next_version.outputs.tag }} created successfully!"
          echo ""
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.next_version.outputs.tag }}"
        else
          echo "âŒ Failed to verify release"
          exit 1
        fi
