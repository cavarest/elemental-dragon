name: release

on:
  workflow_dispatch:
    inputs:
      next_version:
        description: |
          Next release version. Possible values: x.y.z, major, minor, patch.
          Also, you can pass 'skip' to skip git tag and create release for the current version.
        required: true
        type: string
      release_title:
        description: 'Title for the GitHub release (optional, defaults to version)'
        required: false
        type: string
      release_notes:
        description: 'Release notes (optional, defaults to changelog)'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Get current version from build.gradle
      id: current_version
      run: |
        import os
        import re

        with open('build.gradle', 'r') as f:
            content = f.read()
            match = re.search(r"version\s*=\s*['\"]([^'\"]+)['\"]", content)
            if match:
                version_str = match.group(1)
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f'current={version_str}\n')
                print(f'Found version: {version_str}')
            else:
                raise ValueError('Version not found in build.gradle')
      shell: python

    - name: Calculate next version
      id: next_version
      run: |
        import os

        current_version = '${{ steps.current_version.outputs.current }}'
        next_version_input = '${{ inputs.next_version }}'

        # Parse current version manually
        parts = current_version.split('.')
        major, minor, patch = int(parts[0]), int(parts[1]), int(parts[2])

        # Calculate next version
        if next_version_input == 'major':
            next_ver = f'{major + 1}.0.0'
        elif next_version_input == 'minor':
            next_ver = f'{major}.{minor + 1}.0'
        elif next_version_input == 'patch':
            next_ver = f'{major}.{minor}.{patch + 1}'
        elif next_version_input == 'skip':
            next_ver = current_version
        else:
            next_ver = next_version_input

        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'next={next_ver}\n')
            f.write(f'tag=v{next_ver}\n')
        print(f'Next version: {next_ver}')
      shell: python

    - name: Update version in gradle.properties
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        import re

        next_ver = '${{ steps.next_version.outputs.next }}'

        # Update gradle.properties (single source of truth)
        with open('gradle.properties', 'r') as f:
            content = f.read()
        content = re.sub(
            r'(project.version=).*',
            lambda m: m.group(1) + next_ver,
            content
        )
        with open('gradle.properties', 'w') as f:
            f.write(content)

        print(f'Updated version to {next_ver}')
      shell: python

    - name: Commit version bump
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        NEXT="${{ steps.next_version.outputs.next }}"
        git add gradle.properties
        git commit -m "chore: bump version to $NEXT"
        git push

    - name: Create and push git tag
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        TAG="${{ steps.next_version.outputs.tag }}"
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"
        echo "Created and pushed tag: $TAG"

    - name: Build plugin using Gradle (production build)
      run: |
        echo "üèóÔ∏è Building production plugin..."
        chmod +x build.sh
        ./build.sh --production
        echo "‚úÖ Plugin built successfully"

    - name: Build slim JAR for advanced users
      run: |
        echo "üì¶ Building slim JAR (no bundled dependencies)..."
        ./gradlew slimJar
        echo "‚úÖ Slim JAR built successfully"

    - name: Download dependency JARs
      run: |
        echo "üì• Downloading dependency JARs for GitHub release..."
        mkdir -p build/deps

        # Download ProtocolSidebar (latest master-SNAPSHOT)
        curl -L "https://jitpack.io/com/github/CatCoderr/ProtocolSidebar/master-SNAPSHOT/ProtocolSidebar-master-SNAPSHOT.jar" \
          -o build/deps/ProtocolSidebar-master-SNAPSHOT.jar || echo "‚ö†Ô∏è  ProtocolSidebar download failed"

        # Download FoliaLib
        curl -L "https://repo.tcoded.com/releases/com/tcoded/FoliaLib/0.5.1/FoliaLib-0.5.1.jar" \
          -o build/deps/FoliaLib-0.5.1.jar || echo "‚ö†Ô∏è  FoliaLib download failed"

        ls -lh build/deps/
        echo "‚úÖ Dependencies downloaded"

    - name: Verify plugin.yml structure
      run: |
        echo "üîç Verifying plugin.yml structure..."
        JAR_FILE=$(find build/libs -name "elemental-dragon-*.jar" | head -1)
        echo "Found JAR: $JAR_FILE"
        jar tf "$JAR_FILE" | grep plugin.yml
        echo "‚úÖ Plugin.yml verified"

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.next_version.outputs.tag }}
        name: ${{ inputs.release_title || format('Elemental Dragon Plugin {0}', steps.next_version.outputs.next) }}
        body: ${{ inputs.release_notes }}
        draft: false
        prerelease: false
        files: |
          build/libs/elemental-dragon-*.jar
          build/deps/*.jar
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify Release
      run: |
        echo "üéâ Release ${{ steps.next_version.outputs.tag }} created successfully!"
        echo ""
        echo "üîó https://github.com/${{ github.repository }}/releases/tag/${{ steps.next_version.outputs.tag }}"

    - name: Distribute to Modrinth and Hangar
      if: ${{ inputs.next_version != 'skip' }}
      uses: ./.github/workflows/distribution.yml
      with:
        tag: ${{ steps.next_version.outputs.tag }}
        version: ${{ steps.next_version.outputs.next }}
        release_title: ${{ inputs.release_title }}
        release_notes: ${{ inputs.release_notes }}
