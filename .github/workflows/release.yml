name: release

on:
  workflow_dispatch:
    inputs:
      next_version:
        description: |
          Next release version. Possible values: x.y.z, major, minor, patch.
          Also, you can pass 'skip' to skip git tag and create release for the current version.
        required: true
        type: string
      release_title:
        description: 'Title for the GitHub release (optional, defaults to version)'
        required: false
        type: string
      release_notes:
        description: 'Release notes (optional, defaults to changelog)'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Get current version from build.gradle
      id: current_version
      run: |
        CURRENT_VERSION=$(grep "^version " build.gradle | head -1 | sed "s/version = '//" | sed "s/'//g" | sed "s/ //g")
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Detected current version: $CURRENT_VERSION"

    - name: Calculate next version
      id: next_version
      run: |
        CURRENT="${{ steps.current_version.outputs.current }}"

        if [[ "${{ inputs.next_version }}" == "major" ]]; then
          NEXT=$(echo $CURRENT | awk -F. '{print $1+1".0.0"}')
        elif [[ "${{ inputs.next_version }}" == "minor" ]]; then
          NEXT=$(echo $CURRENT | awk -F. '{print $1"."$2+1".0"}')
        elif [[ "${{ inputs.next_version }}" == "patch" ]]; then
          NEXT=$(echo $CURRENT | awk -F. '{print $1"."$2"."$3+1}')
        elif [[ "${{ inputs.next_version }}" == "skip" ]]; then
          NEXT=$CURRENT
        else
          NEXT="${{ inputs.next_version }}"
        fi

        echo "next=$NEXT" >> $GITHUB_OUTPUT
        echo "tag=v$NEXT" >> $GITHUB_OUTPUT
        echo "Calculated next version: $NEXT"

    - name: Update version in build.gradle and gradle.properties
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        NEXT="${{ steps.next_version.outputs.next }}"
        # Update build.gradle
        sed -i "s/^version = .*/version = '$NEXT'/" build.gradle
        # Update gradle.properties
        sed -i "s/^project.version=.*/project.version=$NEXT/" gradle.properties
        echo "Updated version to $NEXT in build.gradle and gradle.properties"

    - name: Commit version bump
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        NEXT="${{ steps.next_version.outputs.next }}"
        git add build.gradle
        git commit -m "chore: bump version to $NEXT"
        git push

    - name: Create and push git tag
      if: ${{ inputs.next_version != 'skip' }}
      run: |
        TAG="${{ steps.next_version.outputs.tag }}"
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"
        echo "Created and pushed tag: $TAG"

    - name: Build plugin using Gradle (production build)
      run: |
        echo "ğŸ—ï¸ Building production plugin..."
        chmod +x build.sh
        ./build.sh --production
        echo "âœ… Plugin built successfully"

    - name: Verify plugin.yml structure
      run: |
        echo "ğŸ” Verifying plugin.yml structure..."
        JAR_FILE=$(find build/libs -name "elemental-dragon-*.jar" | head -1)
        echo "Found JAR: $JAR_FILE"
        jar tf "$JAR_FILE" | grep plugin.yml
        echo "âœ… Plugin.yml verified"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.next_version.outputs.tag }}
        name: ${{ inputs.release_title || format('Elemental Dragon Plugin {0}', steps.next_version.outputs.next) }}
        body: ${{ inputs.release_notes }}
        draft: false
        prerelease: false
        files: |
          build/libs/elemental-dragon-*.jar
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify Release
      run: |
        echo "ğŸ‰ Verifying release creation..."
        echo ""

        if gh release view ${{ steps.next_version.outputs.tag }} --json id --jq '.id' 2>/dev/null; then
          echo "âœ… Release ${{ steps.next_version.outputs.tag }} created successfully!"
          echo ""
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.next_version.outputs.tag }}"
        else
          echo "âŒ Failed to verify release"
          exit 1
        fi
