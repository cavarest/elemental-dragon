name: Link Check

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

# Cancel in-progress runs for the same branch
concurrency:
  group: link-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  link-check:
    name: Check Documentation Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true
          cache-version: 0
          working-directory: docs

      - name: Cache Lychee results
        uses: actions/cache@v3
        with:
          path: docs/.lychee-cache
          key: ${{ runner.os }}-lychee-${{ hashFiles('docs/**') }}
          restore-keys: |
            ${{ runner.os }}-lychee-

      - name: Build Jekyll site
        run: bundle exec jekyll build
        working-directory: docs
        env:
          JEKYLL_ENV: production

      - name: Run Lychee link checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: "--verbose --no-progress 'docs/_site/**/*.html' --cache --max-cache-age 1d --exclude 'https://cavarest.github.io/elemental-dragon/*'"
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue if links are broken (on push to main)
        if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Documentation has broken links',
              body: 'The link check workflow failed on the `main` branch. Please review the workflow logs and fix the broken links.',
              labels: ['documentation', 'bug']
            })
