name: distribution

on:
  workflow_dispatch:
    inputs:
      tag:
        description: |
          Git tag to distribute (e.g., v1.2.5).
          The JAR must already be built and available in build/libs/.
        required: true
        type: string
      release_title:
        description: 'Title for the releases (optional, defaults to version)'
        required: false
        type: string
      changelog_file:
        description: 'Path to CHANGELOG.md (optional, defaults to CHANGELOG.md)'
        required: false
        type: string
        default: 'CHANGELOG.md'
      modrinth_only:
        description: 'Only publish to Modrinth (skip Hangar)'
        required: false
        type: boolean
        default: false
      hangar_only:
        description: 'Only publish to Hangar (skip Modrinth)'
        required: false
        type: boolean
        default: false

jobs:
  # Job to prepare release notes (shared by both Modrinth and Hangar)
  prepare:
    name: Prepare Release Notes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      modrinth_notes: ${{ steps.modrinth_notes.outputs.notes }}
      hangar_notes: ${{ steps.hangar_notes.outputs.notes }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set version variables
      id: version
      run: |
        TAG="${{ inputs.tag }}"
        # Remove 'v' prefix if present
        VERSION="${TAG#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "üì¶ Preparing distribution for $VERSION"

    - name: Extract Changelog
      id: extract_changelog
      shell: python
      run: |
        import re
        import os

        changelog_file = "${{ inputs.changelog_file }}"
        version = "${{ steps.version.outputs.version }}"
        tag = "${{ steps.version.outputs.tag }}"

        with open(changelog_file, 'r') as f:
            content = f.read()

        # Find the section for this version (e.g., [1.3.0])
        # Look from the version header to the next version header or end of file
        pattern = rf'##\[{version}\](.*?)\n(.*?)(?=##\[\d+\.\d+\.\d+\]|$)'

        match = re.search(pattern, content, re.DOTALL)
        if match:
            notes = match.group(1).strip()
        else:
            notes = f"Release {tag}"

        # Write to output file
        with open('/tmp/changelog_notes.txt', 'w') as f:
            f.write(notes)

        print(f"Extracted {len(notes)} characters from changelog")

    - name: Prepare Modrinth Release Notes
      id: modrinth_notes
      run: |
        echo "üìù Generating Modrinth release notes..."

        # Read release notes from file
        if [ -f RELEASE_NOTES.md ]; then
          cat RELEASE_NOTES.md > /tmp/modrinth_final.txt
          echo "" >> /tmp/modrinth_final.txt
        else
          echo "No RELEASE_NOTES.md found, using basic notes" > /tmp/modrinth_final.txt
        fi

        cat /tmp/changelog_notes.txt >> /tmp/modrinth_final.txt
        echo "" >> /tmp/modrinth_final.txt

        # Output for workflow
        {
          echo 'notes<<EOF'
          cat /tmp/modrinth_final.txt
          echo EOF
        } >> $GITHUB_OUTPUT

        echo "‚úÖ Modrinth release notes prepared"

    - name: Prepare Hangar Release Notes
      id: hangar_notes
      run: |
        echo "üìù Generating Hangar release notes..."

        # Read release notes from file
        if [ -f RELEASE_NOTES.md ]; then
          cat RELEASE_NOTES.md > /tmp/hangar_final.txt
          echo "" >> /tmp/hangar_final.txt
        else
          echo "No RELEASE_NOTES.md found, using basic notes" > /tmp/hangar_final.txt
        fi

        # Add dependency note for Hangar
        {
          echo ""
          echo "Required Dependencies (install these on your server first):"
          echo "- ProtocolSidebar (sidebar API): Download from https://jitpack.io/com/github/CatCoderr/ProtocolSidebar/master-SNAPSHOT/ProtocolSidebar-master-SNAPSHOT.jar"
          echo "- FoliaLib (Folia API): https://repo.tcoded.com/releases/com/tcoded/FoliaLib/0.5.1/FoliaLib-0.5.1.jar"
          echo ""
          echo "Place these JARs in your server's plugins folder before installing Elemental Dragon."
        } >> /tmp/hangar_final.txt

        cat /tmp/changelog_notes.txt >> /tmp/hangar_final.txt
        echo "" >> /tmp/hangar_final.txt

        # Output for workflow
        {
          echo 'notes<<EOF'
          cat /tmp/hangar_final.txt
          echo EOF
        } >> $GITHUB_OUTPUT

        echo "‚úÖ Hangar release notes prepared"

  # Modrinth distribution job
  modrinth:
    name: Publish to Modrinth
    needs: prepare
    if: ${{ inputs.modrinth_only != true }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download dependency JARs
      run: |
        echo "üì• Downloading dependency JARs for GitHub release..."
        mkdir -p build/deps

        # Download ProtocolSidebar (latest master-SNAPSHOT)
        curl -L "https://jitpack.io/com/github/CatCoderr/ProtocolSidebar/master-SNAPSHOT/ProtocolSidebar-master-SNAPSHOT.jar" \
          -o build/deps/ProtocolSidebar-master-SNAPSHOT.jar || echo "‚ö†Ô∏è  ProtocolSidebar download failed"

        # Download FoliaLib
        curl -L "https://repo.tcoded.com/releases/com/tcoded/FoliaLib/0.5.1/FoliaLib-0.5.1.jar" \
          -o build/deps/FoliaLib-0.5.1.jar || echo "‚ö†Ô∏è  FoliaLib download failed"

        ls -lh build/deps/
        echo "‚úÖ Dependencies downloaded"

    - name: Publish to Modrinth
      uses: cloudnode-pro/modrinth-publish@v2
      with:
        token: ${{ secrets.MODRINTH_API_KEY }}
        project: 66f6mWei
        version: ${{ needs.prepare.outputs.version }}
        name: ${{ inputs.release_title || format('Elemental Dragon Plugin {0}', needs.prepare.outputs.version) }}
        changelog: ${{ needs.prepare.outputs.modrinth_notes }}
        loaders: |-
          paper
          folia
        game-versions: |-
          1.21.x
        files: build/libs/elemental-dragon-${{ needs.prepare.outputs.version }}.jar

    - name: Modrinth Distribution Summary
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        echo "üéâ Modrinth distribution complete for v$VERSION!"
        echo "üîó https://modrinth.com/plugin/elemental-dragon"

  # Hangar distribution job
  hangar:
    name: Publish to Hangar
    needs: prepare
    if: ${{ inputs.hangar_only != true }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Publish to Hangar
      env:
        HANGER_PAPERMC_API_KEY: ${{ secrets.HANGER_PAPERMC_API_KEY }}
      run: |
        ./gradlew publishPluginPublicationToHangar --stacktrace

    - name: Hangar Distribution Summary
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        echo "üéâ Hangar distribution complete for v$VERSION!"
        echo "üîó https://hangar.papermc.io/ElementalDragon/versions/$VERSION"

  # Distribution summary
  summary:
    name: Distribution Summary
    needs: [modrinth, hangar]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
    - name: Print Summary
      run: |
        VERSION="${{ needs.prepare.outputs.version }}"
        echo "üéâ Distribution complete for v$VERSION!"
        echo ""
        echo "üì¶ Platforms:"
        if [ "${{ inputs.modrinth_only }}" != "true" ]; then
          echo "  ‚úÖ Modrinth: https://modrinth.com/plugin/elemental-dragon"
        fi
        if [ "${{ inputs.hangar_only }}" != "true" ]; then
          echo "  ‚úÖ Hangar: https://hangar.papermc.io/ElementalDragon/versions/$VERSION"
        fi
